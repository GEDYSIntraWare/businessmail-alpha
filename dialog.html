<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <title>Dialog - Business Mail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Office.js MUSS geladen werden f체r Dialog-Kommunikation -->
  <script type="text/javascript" src="./assets/office-js/office.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      color: #323130;
      background: #ffffff;
      height: 100vh;
      overflow: hidden;
    }

    .dialog-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 20px;
    }

    /* Loading State */
    .dialog-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0078d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      color: #605e5c;
      font-size: 14px;
    }

    .error-text {
      color: #d32f2f;
      font-size: 14px;
      text-align: center;
      max-width: 300px;
    }

    /* Dialog Content */
    .dialog-content {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .dialog-content.visible {
      display: flex;
    }

    /* Header */
    .dialog-header {
      flex-shrink: 0;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 16px;
    }

    .dialog-title {
      font-size: 20px;
      font-weight: 600;
      color: #323130;
    }

    /* Body */
    .dialog-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .dialog-message {
      font-size: 14px;
      line-height: 1.6;
      color: #605e5c;
    }

    .dialog-data {
      margin-top: 16px;
      padding: 12px;
      background-color: #f5f5f5;
      border-radius: 4px;
      overflow-x: auto;
    }

    .dialog-data pre {
      font-size: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }

    /* Form Fields */
    .dialog-form {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #323130;
    }

    .form-label .required {
      color: #d32f2f;
      margin-left: 2px;
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #8a8886;
      border-radius: 4px;
      transition: border-color 0.15s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #0078d4;
      box-shadow: 0 0 0 1px #0078d4;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 80px;
    }

    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23605e5c' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 14px;
      color: #605e5c;
    }

    /* Actions */
    .dialog-actions {
      flex-shrink: 0;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
      margin-top: auto;
    }

    .btn {
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      min-width: 90px;
    }

    .btn-primary {
      background-color: #0078d4;
      color: white;
    }

    .btn-primary:hover {
      background-color: #106ebe;
    }

    .btn-primary:active {
      background-color: #005a9e;
    }

    .btn-secondary {
      background-color: #f3f2f1;
      color: #323130;
      border: 1px solid #8a8886;
    }

    .btn-secondary:hover {
      background-color: #e1dfdd;
    }

    .btn-secondary:active {
      background-color: #c8c6c4;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="dialog-container">
    <!-- Loading State -->
    <div id="loadingState" class="dialog-loading">
      <div class="spinner"></div>
      <p class="loading-text">Dialog wird geladen...</p>
      <p id="errorText" class="error-text" style="display: none;"></p>
    </div>

    <!-- Dialog Content (hidden until payload received) -->
    <div id="dialogContent" class="dialog-content">
      <!-- Header -->
      <div id="headerSection" class="dialog-header" style="display: none;">
        <h1 id="dialogTitle" class="dialog-title">Dialog</h1>
      </div>

      <!-- Body (for confirm/info dialogs) -->
      <div id="bodySection" class="dialog-body" style="display: none;">
        <p id="dialogMessage" class="dialog-message"></p>
        <div id="dialogData" class="dialog-data" style="display: none;">
          <pre id="dialogDataContent"></pre>
        </div>
      </div>

      <!-- Form (for form dialogs) -->
      <div id="formSection" class="dialog-form" style="display: none;">
        <div id="formFields"></div>
      </div>

      <!-- Actions -->
      <div id="actionsSection" class="dialog-actions" style="display: none;">
        <button id="cancelBtn" type="button" class="btn btn-secondary">Abbrechen</button>
        <button id="confirmBtn" type="button" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Office.js Dialog Handler
    // ============================================

    /** @type {Object|null} */
    let dialogPayload = null;

    /** @type {Object<string, any>} */
    let formData = {};

    /**
     * Initialisiert den Dialog wenn Office.js bereit ist
     */
    Office.onReady(function (info) {

      // Handler f체r Nachrichten vom Parent registrieren
      if (Office.context.ui && Office.context.ui.addHandlerAsync) {
        Office.context.ui.addHandlerAsync(
          Office.EventType.DialogParentMessageReceived,
          onParentMessage,
          function (asyncResult) {
            if (asyncResult.status !== Office.AsyncResultStatus.Succeeded) {
              showError('Fehler bei der Dialog-Initialisierung');
            }
          }
        );
      } else {
        showError('Office.js Dialog-API nicht verf체gbar');
      }

      document.getElementById('confirmBtn').addEventListener('click', onConfirm);
      document.getElementById('cancelBtn').addEventListener('click', onCancel);
    });

    function onParentMessage(arg) {

      try {
        if (arg && arg.message) {
          dialogPayload = JSON.parse(arg.message);
          renderDialog(dialogPayload);
        } else {
          throw new Error('Invalid message format');
        }
      } catch (e) {
        showError('Error parsing dialog payload: ' + e.message);
      }
    }

    function renderDialog(payload) {
      const components = payload.components || ['header', 'body', 'actions'];

      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('dialogContent').classList.add('visible');

      if (components.includes('header')) {
        renderHeader(payload);
      }

      if (components.includes('body')) {
        renderBody(payload);
      }

      if (components.includes('form-fields')) {
        renderFormFields(payload);
      }

      if (components.includes('actions')) {
        renderActions(payload);
      }
    }

    function renderHeader(payload) {
      const section = document.getElementById('headerSection');
      const title = document.getElementById('dialogTitle');

      title.textContent = payload.title || 'Dialog';
      section.style.display = 'block';
    }

    function renderBody(payload) {
      const section = document.getElementById('bodySection');
      const message = document.getElementById('dialogMessage');
      const dataContainer = document.getElementById('dialogData');
      const dataContent = document.getElementById('dialogDataContent');

      if (payload.message) {
        message.textContent = payload.message;
      }

      if (payload.data && payload.type === 'info') {
        dataContent.textContent = JSON.stringify(payload.data, null, 2);
        dataContainer.style.display = 'block';
      }

      section.style.display = 'block';
    }

    function renderFormFields(payload) {
      const section = document.getElementById('formSection');
      const container = document.getElementById('formFields');

      const fields = (payload.data && payload.data.fields) || [];

      if (fields.length === 0) {
        container.innerHTML = '<p style="color: #605e5c; font-style: italic;">Keine Formularfelder definiert.</p>';
        section.style.display = 'block';
        return;
      }

      let html = '';

      fields.forEach(function (field) {
        const required = field.required ? '<span class="required">*</span>' : '';
        const requiredAttr = field.required ? 'required' : '';

        html += '<div class="form-group">';
        html += '<label class="form-label" for="' + field.name + '">' + field.label + required + '</label>';

        switch (field.type) {
          case 'textarea':
            html += '<textarea id="' + field.name + '" name="' + field.name + '" class="form-control" ' +
              'placeholder="' + (field.placeholder || '') + '" ' + requiredAttr + ' rows="3"></textarea>';
            break;

          case 'select':
            html += '<select id="' + field.name + '" name="' + field.name + '" class="form-control" ' + requiredAttr + '>';
            html += '<option value="" disabled selected>' + (field.placeholder || 'Bitte w채hlen...') + '</option>';
            if (field.options) {
              field.options.forEach(function (opt) {
                html += '<option value="' + opt.value + '">' + opt.label + '</option>';
              });
            }
            html += '</select>';
            break;

          case 'checkbox':
            html += '<div class="checkbox-wrapper">';
            html += '<input type="checkbox" id="' + field.name + '" name="' + field.name + '" class="form-checkbox" />';
            html += '<span class="checkbox-label">' + (field.placeholder || '') + '</span>';
            html += '</div>';
            break;

          default:
            html += '<input type="' + (field.type || 'text') + '" id="' + field.name + '" name="' + field.name + '" ' +
              'class="form-control" placeholder="' + (field.placeholder || '') + '" ' + requiredAttr + ' />';
        }

        html += '</div>';

        formData[field.name] = field.defaultValue !== undefined ? field.defaultValue :
          (field.type === 'checkbox' ? false : '');
      });

      container.innerHTML = html;
      section.style.display = 'block';

      fields.forEach(function (field) {
        const element = document.getElementById(field.name);
        if (element) {
          element.addEventListener('change', function (e) {
            if (field.type === 'checkbox') {
              formData[field.name] = e.target.checked;
            } else {
              formData[field.name] = e.target.value;
            }
          });

          if (field.type !== 'checkbox' && field.type !== 'select') {
            element.addEventListener('input', function (e) {
              formData[field.name] = e.target.value;
            });
          }

          if (field.defaultValue !== undefined) {
            if (field.type === 'checkbox') {
              element.checked = field.defaultValue;
            } else {
              element.value = field.defaultValue;
            }
          }
        }
      });
    }

    function renderActions(payload) {
      const section = document.getElementById('actionsSection');
      const confirmBtn = document.getElementById('confirmBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      if (payload.labels) {
        if (payload.labels.confirm) {
          confirmBtn.textContent = payload.labels.confirm;
        }
        if (payload.labels.cancel) {
          cancelBtn.textContent = payload.labels.cancel;
        }
      }

      section.style.display = 'flex';
    }

    function onConfirm() {
      const resultData = dialogPayload && dialogPayload.components &&
        dialogPayload.components.includes('form-fields')
        ? collectFormData()
        : dialogPayload ? dialogPayload.data : undefined;

      sendResultToParent({ ok: true, data: resultData });
    }

    function onCancel() {
      sendResultToParent({ ok: false, error: 'Canceled' });
    }

    /**
     * Sammelt alle Formular-Daten
     * @returns {Object}
     */
    function collectFormData() {
      const fields = (dialogPayload && dialogPayload.data && dialogPayload.data.fields) || [];
      const result = {};

      fields.forEach(function (field) {
        const element = document.getElementById(field.name);
        if (element) {
          if (field.type === 'checkbox') {
            result[field.name] = element.checked;
          } else {
            result[field.name] = element.value;
          }
        }
      });

      return result;
    }

    function sendResultToParent(result) {

      try {
        Office.context.ui.messageParent(JSON.stringify(result));
      } catch (e) {
        showError('Error while sending result to parent: ' + e.message);
      }
    }

    function showError(message) {
      const errorText = document.getElementById('errorText');
      const spinner = document.querySelector('.spinner');
      const loadingText = document.querySelector('.loading-text');

      if (spinner) spinner.style.display = 'none';
      if (loadingText) loadingText.style.display = 'none';

      errorText.textContent = message;
      errorText.style.display = 'block';
    }
  </script>
</body>

</html>